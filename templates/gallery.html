{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Gallery</h2>
    
    <div class="row" id="gallery-container">
        <!-- Gallery items will be loaded here -->
    </div>

    <nav aria-label="Gallery navigation" class="mt-4">
        <ul class="pagination justify-content-center" id="pagination">
            <!-- Pagination will be added here -->
        </ul>
    </nav>
</div>

<script>
let currentPage = 1;
const perPage = 12;

async function loadGallery(page = 1) {
    try {
        const response = await fetch(`/gallery?page=${page}&per_page=${perPage}`);
        const data = await response.json();
        
        const container = document.getElementById('gallery-container');
        container.innerHTML = '';
        
        Object.entries(data.items).forEach(([id, item]) => {
            const col = document.createElement('div');
            col.className = 'col-md-4 col-lg-3 mb-4';
            
            col.innerHTML = `
                <div class="card h-100">
                    <img src="${item.thumbnail_url}" class="card-img-top" alt="Colorized image">
                    <div class="card-body">
                        <p class="card-text text-muted">${new Date(item.created_at).toLocaleDateString()}</p>
                        <a href="${item.result_url}" class="btn btn-primary btn-sm" target="_blank">View Full Size</a>
                    </div>
                </div>
            `;
            
            container.appendChild(col);
        });
        
        // Update pagination
        const totalPages = Math.ceil(data.total / perPage);
        updatePagination(page, totalPages);
        
        // Highlight recently processed image if any
        const lastProcessed = sessionStorage.getItem('lastProcessedImage');
        if (lastProcessed) {
            const processedData = JSON.parse(lastProcessed);
            highlightProcessedImage(processedData.imageId);
            sessionStorage.removeItem('lastProcessedImage');
        }
    } catch (error) {
        console.error('Error loading gallery:', error);
    }
}

function updatePagination(currentPage, totalPages) {
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    
    // Previous button
    pagination.innerHTML += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadGallery(${currentPage - 1})" ${currentPage === 1 ? 'tabindex="-1" aria-disabled="true"' : ''}>Previous</a>
        </li>
    `;
    
    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        pagination.innerHTML += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="loadGallery(${i})">${i}</a>
            </li>
        `;
    }
    
    // Next button
    pagination.innerHTML += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadGallery(${currentPage + 1})" ${currentPage === totalPages ? 'tabindex="-1" aria-disabled="true"' : ''}>Next</a>
        </li>
    `;
}

function highlightProcessedImage(imageId) {
    const cards = document.querySelectorAll('.card');
    cards.forEach(card => {
        if (card.querySelector(`[data-image-id="${imageId}"]`)) {
            card.classList.add('border-primary');
            card.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    });
}

// Load gallery when page loads
document.addEventListener('DOMContentLoaded', () => loadGallery(1));
</script>
{% endblock %}