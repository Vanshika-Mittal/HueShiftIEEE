{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <h1 class="text-center mb-4">HueShift Gallery</h1>
    
    <ul class="nav nav-tabs" id="galleryTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="diffusion-tab" data-bs-toggle="tab" data-bs-target="#diffusion" type="button" role="tab" aria-controls="diffusion" aria-selected="true">Diffusion Model Results</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="gan-tab" data-bs-toggle="tab" data-bs-target="#gan" type="button" role="tab" aria-controls="gan" aria-selected="false">GAN Model Results</button>
        </li>
    </ul>
    
    <div class="tab-content" id="galleryTabContent">
        <!-- Diffusion Model Tab -->
        <div class="tab-pane fade show active" id="diffusion" role="tabpanel" aria-labelledby="diffusion-tab">
            {% if diffusion_samples %}
                {% for sample in diffusion_samples %}
                    <div class="card mb-5">
                        <div class="card-header">
                            <h3>{{ sample.display_name }}</h3>
                        </div>
                        <div class="card-body">
                            <div class="row mb-4">
                                <!-- Main videos in exact specified order -->
                                <div class="video-container">
                                    {% if sample.ground_truth %}
                                    <div class="video-item">
                                        <h5>Ground Truth</h5>
                                        <video class="sync-video" src="{{ sample.ground_truth }}" loop muted playsinline></video>
                                    </div>
                                    {% endif %}
                                    
                                    {% if sample.grayscale %}
                                    <div class="video-item">
                                        <h5>Black & White Input</h5>
                                        <video class="sync-video" src="{{ sample.grayscale }}" loop muted playsinline></video>
                                    </div>
                                    {% endif %}
                                    
                                    {% if sample.low_res_output %}
                                    <div class="video-item">
                                        <h5>Low Resolution Output</h5>
                                        <video class="sync-video" src="{{ sample.low_res_output }}" loop muted playsinline></video>
                                    </div>
                                    {% endif %}
                                    
                                    {% if sample.high_res_output %}
                                    <div class="video-item">
                                        <h5>High Resolution Output</h5>
                                        <video class="sync-video" src="{{ sample.high_res_output }}" loop muted playsinline></video>
                                    </div>
                                    {% endif %}
                                    
                                    {% if sample.final_output %}
                                    <div class="video-item">
                                        <h5>Final Output</h5>
                                        <video class="sync-video" src="{{ sample.final_output }}" loop muted playsinline></video>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Expandable section for additional outputs -->
                            <div class="accordion" id="additional-{{ sample.name }}">
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="heading-{{ sample.name }}">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ sample.name }}" aria-expanded="false" aria-controls="collapse-{{ sample.name }}">
                                            Additional Processing Steps & Comparison
                                        </button>
                                    </h2>
                                    <div id="collapse-{{ sample.name }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ sample.name }}" data-bs-parent="#additional-{{ sample.name }}">
                                        <div class="accordion-body">
                                            <div class="row">
                                                {% if sample.stage_1 %}
                                                <div class="col-md-6 mb-3">
                                                    <h5>Stage 1 Reconstruction</h5>
                                                    <video class="additional-video" src="{{ sample.stage_1 }}" loop muted playsinline></video>
                                                </div>
                                                {% endif %}
                                                
                                                {% if sample.neural_filter %}
                                                <div class="col-md-6 mb-3">
                                                    <h5>Neural Filter Output</h5>
                                                    <video class="additional-video" src="{{ sample.neural_filter }}" loop muted playsinline></video>
                                                </div>
                                                {% endif %}
                                                
                                                {% if sample.global_info %}
                                                <div class="col-md-6 mb-3">
                                                    <h5>Global Info (Comparison Loss)</h5>
                                                    <video class="additional-video" src="{{ sample.global_info }}" loop muted playsinline></video>
                                                </div>
                                                {% endif %}
                                                
                                                {% if sample.concatenated %}
                                                <div class="col-md-6 mb-3">
                                                    <h5>Combined Process Visualization</h5>
                                                    <video class="additional-video" src="{{ sample.concatenated }}" loop muted playsinline></video>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="alert alert-info mt-4">No diffusion model samples found.</div>
            {% endif %}
        </div>
        
        <!-- GAN Model Tab -->
        <div class="tab-pane fade" id="gan" role="tabpanel" aria-labelledby="gan-tab">
            <div class="row mt-4">
                {% if gan_samples %}
                    <div class="mt-4 mb-4">
                        <h3>Samples by Complexity:</h3>
                        <div class="btn-group mb-4" role="group">
                            <button type="button" class="btn btn-outline-primary gan-filter active" data-complexity="all">All</button>
                            <button type="button" class="btn btn-outline-primary gan-filter" data-complexity="simple">Simple</button>
                            <button type="button" class="btn btn-outline-primary gan-filter" data-complexity="slightly-complex">Slightly Complex</button>
                            <button type="button" class="btn btn-outline-primary gan-filter" data-complexity="very-complex">Very Complex</button>
                        </div>
                    </div>
                    
                    {% for sample in gan_samples %}
                        <div class="col-md-6 mb-4 gan-sample" data-complexity="{{ sample.complexity }}">
                            <div class="card">
                                <div class="card-header">
                                    <h4>{{ sample.display_name }}</h4>
                                    <span class="badge bg-primary">{{ sample.complexity }}</span>
                                </div>
                                <div class="card-body">
                                    <video class="w-100" src="{{ sample.output }}" loop muted playsinline></video>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="alert alert-info mt-4">No GAN model samples found.</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
    .video-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
    }
    
    .video-item {
        flex: 1;
        min-width: 160px;
        max-width: 240px;
        text-align: center;
    }
    
    .video-item video {
        width: 100%;
        height: auto;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    .accordion-button:not(.collapsed) {
        background-color: rgba(0, 123, 255, 0.1);
        color: #0056b3;
    }
    
    .additional-video {
        width: 100%;
        height: auto;
        border: 1px solid #ddd;
        border-radius: 4px;
        max-width: 320px;
        display: block;
        margin: 0 auto;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Function to play all videos in a group
        function playAllVideos(videoElements) {
            // Play all videos
            const playPromises = Array.from(videoElements).map(video => {
                // Reset any playback rate adjustments
                video.playbackRate = 1.0;
                
                // Set attributes for proper looping
                video.loop = true;
                video.muted = true;
                
                // Play the video
                return video.play().catch(e => {
                    console.log('Auto-play was prevented:', e);
                });
            });
            
            // After all videos have started playing, ensure they're at the same time
            Promise.all(playPromises).then(() => {
                syncVideoTimes(videoElements);
            });
        }
        
        // Function to synchronize video times
        function syncVideoTimes(videoElements) {
            if (videoElements.length < 2) return;
            
            // Use the first video as reference
            const refTime = videoElements[0].currentTime;
            
            // Sync all other videos to match
            videoElements.forEach((video, index) => {
                if (index > 0 && Math.abs(video.currentTime - refTime) > 0.1) {
                    video.currentTime = refTime;
                }
            });
        }
        
        // Get all video containers
        const videoGroups = document.querySelectorAll('.video-container');
        
        // Process each video group
        videoGroups.forEach(group => {
            const videos = Array.from(group.querySelectorAll('.sync-video'));
            
            // Play all videos on page load
            playAllVideos(videos);
            
            // Set up periodic sync to keep videos aligned
            setInterval(() => {
                syncVideoTimes(videos);
                
                // Check for paused videos and restart them
                videos.forEach(video => {
                    if (video.paused && !document.hidden) {
                        video.play().catch(e => console.log('Auto-play was prevented:', e));
                    }
                });
            }, 1000);
            
            // Set up event listeners for keeping videos in sync
            videos.forEach(video => {
                // When one video plays, play all videos
                video.addEventListener('play', () => {
                    videos.forEach(v => {
                        if (v !== video && v.paused) {
                            v.play().catch(e => console.log('Could not sync play:', e));
                        }
                        v.currentTime = video.currentTime;
                    });
                });
                
                // When one video pauses, pause all videos
                video.addEventListener('pause', () => {
                    videos.forEach(v => {
                        if (v !== video && !v.paused) {
                            v.pause();
                        }
                    });
                });
                
                // When one video seeks, seek all videos
                video.addEventListener('seeked', () => {
                    videos.forEach(v => {
                        if (v !== video) {
                            v.currentTime = video.currentTime;
                        }
                    });
                });
                
                // Add click handling for play/pause
                video.addEventListener('click', () => {
                    if (video.paused) {
                        videos.forEach(v => v.play().catch(e => console.log('Could not play on click:', e)));
                    } else {
                        videos.forEach(v => v.pause());
                    }
                });
            });
        });
        
        // Handle accordion videos (additional videos)
        const accordionButtons = document.querySelectorAll('.accordion-button');
        accordionButtons.forEach(button => {
            button.addEventListener('click', function() {
                const isExpanded = this.getAttribute('aria-expanded') === 'true';
                const collapseId = this.getAttribute('data-bs-target').substring(1);
                const collapse = document.getElementById(collapseId);
                
                setTimeout(() => {
                    const additionalVideos = Array.from(collapse.querySelectorAll('.additional-video'));
                    
                    additionalVideos.forEach(video => {
                        video.loop = true;
                        video.muted = true;
                    });
                    
                    if (!isExpanded) {
                        // Play all additional videos when accordion opens
                        playAllVideos(additionalVideos);
                    }
                    
                    // Add click handling for additional videos
                    additionalVideos.forEach(video => {
                        video.onclick = function() {
                            if (this.paused) {
                                additionalVideos.forEach(v => v.play().catch(e => {}));
                            } else {
                                additionalVideos.forEach(v => v.pause());
                            }
                        };
                    });
                    
                    // Set up periodic sync for additional videos
                    setInterval(() => {
                        syncVideoTimes(additionalVideos);
                    }, 1000);
                }, 350);
            });
        });
        
        // Handle GAN videos
        const ganVideos = document.querySelectorAll('.gan-sample video');
        ganVideos.forEach(video => {
            video.loop = true;
            video.muted = true;
            video.play().catch(e => console.log('GAN video autoplay prevented:', e));
            
            // Add click to play/pause
            video.addEventListener('click', function() {
                if (this.paused) {
                    this.play().catch(e => {});
                } else {
                    this.pause();
                }
            });
        });
        
        // GAN filtering
        const ganFilters = document.querySelectorAll('.gan-filter');
        const ganSamples = document.querySelectorAll('.gan-sample');
        
        ganFilters.forEach(filter => {
            filter.addEventListener('click', () => {
                // Update active button
                ganFilters.forEach(f => f.classList.remove('active'));
                filter.classList.add('active');
                
                const complexity = filter.getAttribute('data-complexity');
                
                ganSamples.forEach(sample => {
                    if (complexity === 'all' || sample.getAttribute('data-complexity') === complexity) {
                        sample.style.display = 'block';
                    } else {
                        sample.style.display = 'none';
                    }
                });
            });
        });
    });
</script>
{% endblock %}